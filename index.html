<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SIP Flow Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #f4f7f9; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; font-size: 24px; border-left: 5px solid var(--primary-color); padding-left: 15px; margin-bottom: 25px; }
        textarea { width: 100%; height: 250px; padding: 15px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Courier New', monospace; font-size: 13px; resize: vertical; outline: none; transition: border-color 0.3s; }
        textarea:focus { border-color: var(--primary-color); }
        .controls { margin-top: 15px; text-align: right; }
        button { background-color: var(--primary-color); color: white; border: none; padding: 12px 25px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; transition: background 0.3s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #status { margin-top: 10px; font-size: 14px; color: #666; }
        #diagram-container { margin-top: 30px; padding: 20px; border: 1px dashed #ccc; border-radius: 8px; background: #fff; min-height: 200px; overflow-x: auto; }
        .error-box { color: #e74c3c; background: #fdf2f2; padding: 15px; border-radius: 6px; border: 1px solid #fab1a0; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h1>SIP Log AI 시각화 도구</h1>
    <p style="font-size: 14px; color: #7f8c8d;">SIP 로그를 아래에 붙여넣으면 AI가 시퀀스 다이어그램을 생성합니다.</p>
    
    <textarea id="logInput" placeholder="SIP 로그를 복사하여 붙여넣으세요."></textarea>
    
    <div class="controls">
        <span id="status"></span>
        <button id="btnAnalyze" onclick="generateFlow()">Flow 생성 및 분석</button>
    </div>

    <div id="diagram-container">
        <div id="diagram" class="mermaid">
            graph TD
            A[로그를 입력하고] --> B[버튼을 눌러주세요]
        </div>
    </div>
</div>

<script>
    // Mermaid 초기화
    mermaid.initialize({ 
        startOnLoad: false, 
        theme: 'default',
        securityLevel: 'loose'
    });

    async function generateFlow() {
        const logInput = document.getElementById('logInput');
        const btn = document.getElementById('btnAnalyze');
        const status = document.getElementById('status');
        const diagramDiv = document.getElementById('diagram');

        if (!logInput.value.trim()) {
            alert("로그를 입력해주세요.");
            return;
        }

        btn.disabled = true;
        status.innerText = "AI 분석 및 다이어그램 생성 중...";
        diagramDiv.innerHTML = "";

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ log: logInput.value })
            });

            const data = await response.json();

            // 서버에서 에러 객체를 보낸 경우 처리
            if (!response.ok || data.error) {
                const errorMsg = typeof data.error === 'object' ? JSON.stringify(data.error, null, 2) : data.error;
                throw new Error(errorMsg || `서버 오류 (Status: ${response.status})`);
            }

            // 1. Mermaid 코드 정제
            let cleanCode = data.mermaidCode
                .replace(/```mermaid/g, "")
                .replace(/```/g, "")
                .trim();

            // 2. Syntax Error 방지 (필수 선언문 보정)
            if (!cleanCode.startsWith("sequenceDiagram") && !cleanCode.startsWith("graph")) {
                cleanCode = "sequenceDiagram\n" + cleanCode;
            }

            // 3. 렌더링
            diagramDiv.innerHTML = cleanCode;
            diagramDiv.removeAttribute('data-processed');
            
            await mermaid.run({ nodes: [diagramDiv] });
            status.innerText = "분석 완료";

        } catch (err) {
            console.error(err);
            // [object Object] 방지를 위해 상세 에러 메시지 출력
            diagramDiv.innerHTML = `<div class="error-box"><strong>오류 발생:</strong>\n${err.message}</div>`;
            status.innerText = "오류 발생";
        } finally {
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
